<%- include('../layout/header.ejs') %>

<!-- Start Hero Section -->
<div class="hero">
    <div class="container">
        <div class="row justify-content-between">
            <div class="col-lg-5">
                <div class="intro-excerpt">
                    <h1>Cart</h1>
                    
                </div>
            </div>
            <div class="col-lg-7"></div>
        </div>
    </div>
</div>
<!-- End Hero Section -->

<div class="untree_co-section before-footer-section">
    <div class="container">
        <div class="row mb-5">
            <div class="site-blocks-table">
                <table class="table">
                    <% if(message && message.length > 0) { %>
                        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
                        <script>
                          // Display SweetAlert message with a "wrong" icon
                          Swal.fire({
                            title: 'Ohh !!  &#x1F625;',
                            text: '<%= message %>',
                            icon: 'error', // Use 'error' for a "wrong" icon
                            confirmButtonText: 'OK'
                          });
                        </script>
                      <% } %>
                      
                      
        
                    <thead>
                        <tr>
                            <th class="product-thumbnail">Image</th>
                            <th class="product-name">Product</th>
                            <th class="product-price">Price</th>
                            <th class="product-quantity">Quantity</th>
                            <th class="product-remove">Remove</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (cart && cart.products && cart.products.length > 0) { %>
                            <% console.log("Cart Products:", cart.products); %>
                            <% cart.products.forEach(productItem => { %>
                                <tr>
                                    <!-- ... Table rows ... -->
                                    <td class="product-thumbnail">
                                        <% if (productItem.product.images && productItem.product.images.length > 0) { %>
                                            <img src="/productImage/<%= productItem.product.images[0] %>" alt="Image" class="img-fluid">
                                        <% } else { %>
                                            <p>No image available</p>
                                        <% } %>
                                    </td>
                                    <td class="product-name">
                                        <% if ( productItem.product.list === false) { %>
                                            
                                            <h2 class="h5 text-black" style="text-decoration: line-through; color: red;"><%= productItem.product.title %></h2>
                                            <h2 style="color: red;"> Currently Unavailable</h2>
                                          <% } else if(productItem.product.quantity === 0 ){ %>
                                            <h2 class="h5 text-black" style="text-decoration: line-through; color: red;"><%= productItem.product.title %></h2>
                                            <h2 style="color: red;">Temporarily Out Of Stock</h2>
                                            <% } else{ %>
                                            <h2 class="h5 text-black"><%= productItem.product.title %></h2>
                                          <% } %>
                                          

                                    </td>
                                    <td class="product-price">
                                        <%= productItem.price %>
                                    </td>
                                    <td class="product-price">
                                        <div class="quantity-dropdown-container">
                                            <select class="quantity custom-select" name="quantity" id="quantity" data-product-id="<%= productItem.product._id %>" data-current-quantity="<%= productItem.quantity %>">
                                                <% for (let i = 1; i <= productItem.product.quantity; i++) { %>
                                                    <option value="<%= i %>" <%= i === productItem.quantity ? 'selected' : '' %>><%= i %></option>
                                                <% } %>
                                                <% if(productItem.product.quantity ===0) { %>
                                                    <option value="0">Sorry !! Out of Stock</option>
                                                    <% } %>
                                            </select>
                                        </div>
                                    </td>
                                    <!-- Add other columns for product details -->
                                    <td class="product-remove">
                                        <form action="/remove-item" method="post">
                                            <input type="hidden" name="productId" value="<%= productItem.product._id %>">
                                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                                        </form>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <!-- Handle the case where cart or products are null or empty -->
                            <tr>
                                <td colspan="5">
                                    <h4>Your Fushion Furni Cart is empty. <a href="/shop">Continue Shopping</a></h4>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <% if (cart && cart.products && cart.products.length > 0) { %>
            <div class="row">
                <div class="col-md-6">
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <a href="/shop"><button class="btn btn-outline-black btn-sm btn-block">Continue Shopping</button></a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <label class="text-black h4" for="coupon">Coupon</label>
                            <p>Enter your coupon code if you have one.</p>
                        </div>
                        <div class="col-md-8 mb-3 mb-md-0">
                            <input type="text" class="form-control py-3" id="coupon" placeholder="Coupon Code">
                            <div id="couponError" class="text-danger"></div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-black" id="applyCouponBtn">Apply Coupon</button>
                        </div>
                    </div>
                    
                    <br>
                
                    <div class="col-md-4">
                        <button class="btn btn-black" data-toggle="modal" data-target="#couponModal">Available Coupons</button>
                    </div>
                </div>
                <!-- Modal -->
<div class="modal fade" id="couponModal" tabindex="-1" role="dialog" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
               
            </div>
            <!-- Inside your modal body -->
<!-- Inside your modal body -->
<div class="modal-body">
    <% if (coupon.length > 0) { %>
        <div class="row">
            <% coupon.forEach(function(coupon) { %>
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title"><%= coupon.couponName %></h5>
                            <p class="card-text">CODE: <%= coupon.couponCode %></p>
                            <p class="card-text">Discount: ₹ <%= coupon.discountAmount %></p>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    <% } else { %>
        <p>No Coupons</p>
    <% } %>
</div>


            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
                <div class="col-md-6 pl-5">
                    <div class="row justify-content-end">
                        <div class="col-md-7">
                            <div class="row">
                                <div class="col-md-12 text-right border-bottom mb-5">
                                    <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <span class="text-black">Subtotal</span>
                                </div>
                                <div class="col-md-6 text-right">
                                    <strong class="text-black">₹<%= Number(cart.cartTotal) + Number(cart.totalAfterDiscount ?? 0) %></strong>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <span class="text-black">Coupon Discount</span>
                                </div>
                                <div class="col-md-6 text-right">
                                    <strong class="text-black">₹<%= cart.totalAfterDiscount %></strong>
                                </div>
                            </div>
                            <div class="row mb-5">
                                <div class="col-md-6">
                                    <span class="text-black">Total</span>
                                </div>
                                <div class="col-md-6 text-right">
                                    <strong class="text-black">₹<%= cart.cartTotal %></strong>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <a href="/checkout">
                                        <button class="btn btn-black btn-lg py-3 btn-block" onclick="window.location='checkout.html'">Proceed To Checkout</button>
                                    </a>
                                </div>
                            </div>
                              
                              
                        </div>
                    </div>
                </div>
            </div>
        <% } else { %>
            <!-- Handle the case where cart or products are null or empty -->
        <% } %>

    </div>
</div>
    <div class="modal fade" id="outOfStockModal" tabindex="-1" aria-labelledby="outOfStockModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="outOfStockModalLabel">Product Out of Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Delete out-of-stock products from your cart to proceed.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

<!-- Include Axios from CDN -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>   
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var applyCouponBtn = document.getElementById("applyCouponBtn");
        var couponInput = document.getElementById("coupon");
        var couponError = document.getElementById("couponError");

        applyCouponBtn.addEventListener("click", function () {
            var couponCode = couponInput.value;
            couponError.textContent = "";

            if (couponCode.length !== 8) {
                couponError.textContent = "Please Enter a Valid Coupon Code";
            } else {
                axios.post("/apply-coupon", { couponCode: couponCode })
  .then(function (response) {
    console.log("Coupon applied successfully");
    window.location.reload()
    console.log(response.data.cart);
  })
  .catch(function (error) {
    Swal.fire({
    icon: 'error',
    title: 'Error',
    text: error.response.data.message,
  });
  });

            }
        });
    });
    document.addEventListener('DOMContentLoaded', () => {
        const quantityDropdowns = document.querySelectorAll('.quantity');

        quantityDropdowns.forEach(dropdown => {
            dropdown.addEventListener('change', async (event) => {
                const productId = event.target.dataset.productId;
                const currentQuantity = event.target.dataset.currentQuantity;
                const newQuantity = event.target.value;

                if (newQuantity !== currentQuantity && newQuantity !== '0') {
                    try {
                        const response = await axios.post(`/update-quantity/${productId}`, { newQuantity });

                        // Handle the response if needed
                        console.log(response.data);

                        // Refresh the window after a successful update
                        window.location.reload();
                    } catch (error) {
                        console.error('Error:', error);
                    }
                } else {
                    // If new quantity is 0 (out of stock), remove the product from the cart
                    const confirmed = confirm('This product is out of stock. Do you want to remove it from the cart?');
                    if (confirmed) {
                        try {
                            const response = await axios.post(`/remove-item`, { productId });

                            // Handle the response if needed
                            console.log(response.data);

                            // Refresh the window after successful removal
                            window.location.reload();
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    } else {
                        // Reset the dropdown to the previous valid quantity
                        event.target.value = currentQuantity;
                    }
                }
            });
        });

        
const checkoutButton = document.querySelector('.checkout-button');
if (checkoutButton) {
    checkoutButton.addEventListener('click', (event) => {
        const outOfStockProducts = document.querySelectorAll('.quantity option[value="0"]:checked');
        if (outOfStockProducts.length > 0) {
            event.preventDefault(); // Prevent the default action (going to the checkout page)

            const modal = new bootstrap.Modal(document.getElementById('outOfStockModal'));
            modal.show();
        }
    });
}

    });
</script>




<%- include('../layout/footer.ejs') %>





  