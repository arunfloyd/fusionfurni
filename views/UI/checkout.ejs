<%- include('../layout/header.ejs') %>
<!-- Include SweetAlert CSS and JS in your HTML -->
<link rel="stylesheet" href="path/to/sweetalert2.min.css">
<script src="path/to/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>



<!-- Start Hero Section -->
<div class="hero">
    <div class="container">
        <div class="row justify-content-between">
            <div class="col-lg-5">
                <div class="intro-excerpt">
                    <h1>Checkout</h1>
                </div>
            </div>
            <div class="col-lg-7">
            </div>
        </div>
    </div>
</div>
<!-- End Hero Section -->

<div class="form-check mb-3">
</div>

<div class="untree_co-section">
    <div class="container">
        <div class="row mb-5">
            <div class="col-md-6">
                <h2 class="h3 mb-3 text-black">Select a delivery address </h2>
                <div class="p-5 p-lg-5 border bg-white">
                    <form action="/create-order" method="post" id="mainForm">

                        <input class="form-check-input" type="checkbox" id="addAddressCheckbox">
                        <label class="form-check-label" for="addAddressCheckbox">
                            Add Address
                        </label>

                        <div class="row">
                            <% addresses.forEach((address, index) => { %>
                                <div class="card mt-3">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input
                                                type="radio"
                                                name="addressSelection"
                                                id="<%= 'address' + index %>"
                                                class="form-check-input"
                                                value="<%= address.id %>" 
                                                required
                                    >
                                            <label for="<%= 'address' + index %>" class="form-check-label"><%= address.name %></label>
                                            <p class="card-text">
                                                <%= address.mobile %>
                                                <%= address.street %>
                                                <%= address.area %>
                                                <%= address.landmark %>
                                                <%= address.pincode %>
                                                <%= address.addressType %>
                                            </p>
                                            <!-- <a href="#" class="card-link"> Edit</a> -->
                                        </div>
                                    </div>
                                </div>
                        
                                <% if ((index + 1) % 3 === 0) { %>
                                    </div>
                                    <div class="row">
                                <% } %>
                            <% }); %>
                        </div>
                        <br>
                        <br>
                        <div class="border p-3 mb-5">
                            <h3 class="h3 mb-3 text-black">Select A Payment Method</h3>
                            <br><br>

                            <h3 class="h6 mb-0"><a class="d-block" data-bs-toggle="collapse" href="#collapsepaypal" role="button" aria-expanded="false" aria-controls="collapsepaypal">Cash On Delivery ↓</a></h3>
                            <div class="collapse" id="collapsepaypal">
                                <br>
                                <div class="py-2">
                                    <p class="mb-0">
                                        Safe and Flexible Payment Option for the Customer
                                        Cash on Delivery (COD) allows the customer to make the payment after receiving the product in hand- which is the most substantial advantage of this mode of payment.
                                    </p>
                                    <!-- Radio button for Cash On Delivery -->
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="codRadio1" value="COD" required>
                                        <label class="form-check-label" for="codRadio1">
                                          Cash On Delivery
                                        </label>
                                      </div>
                                </div>
                            </div>
                            <br>
                            
                            <h3 class="h6 mb-0"><a class="d-block" data-bs-toggle="collapse" href="#collapsepaypals" role="button" aria-expanded="false" aria-controls="collapsepaypals">Online Payment ↓</a></h3>
                            <div class="collapse" id="collapsepaypals">
                                <br>
                                <div class="py-2">
                                    <p class="mb-0">
                                        Online payments are transactions that occur online. The most common payment forms online are a credit card and debit card; others are an e-wallet, bank transfer, and UPI.
                                    </p>
                                    <!-- Radio button for Online Payment -->
                                    <div class="pay-form">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="codRadio2" value="OnlinePayment" required>
                                        <label class="form-check-label" for="codRadio2">Online Payment<br><br></label>
                                      </div>
                                </div>
                            </div>
                            <br>

                            <h3 class="h6 mb-0"><a class="d-block" data-bs-toggle="collapse" href="#collapsepaypals1" role="button" aria-expanded="false" aria-controls="collapsepaypals">Wallet ↓</a></h3>
                            <div class="collapse" id="collapsepaypals1">
                                <div class="py-2">
                                    <p class="mb-0">
                                        A wallet in e-commerce provides users with a convenient and secure method of making digital payments. Users can load funds into their wallet, and then use these funds to make purchases on the platform without the need to enter credit card details or other payment information for each transaction.
                                    </p>
                                    <!-- Radio button for Online Payment -->
                                    <div class="wallet">
                                        <% if (balance && balance.balance !== undefined) { %>
                                          <p><strong style="font-size: 18px; color: #1c81c5;">Balance Amount: ₹<%= balance.balance %></strong></p>
                                      
                                          <% if (cart && cart.cartTotal !== undefined && cart.cartTotal > (balance.balance || 0)) { %>
                                            <p style="color: red;">Sorry !! insufficient balance </p>
                                            <a href="/wallet" class="styled-link">Click here to LOAD Wallet</a>
                                          <% } else { %>
                                            <input class="form-check-input" type="radio" name="paymentMethod" id="codRadio3" value="Wallet" required>
                                            <label class="form-check-label" for="codRadio3"> Wallet</label>
                                          <% } %>
                                      
                                        <% } else { %>
                                          <p style="color: red;">Oho !! Unable to retrieve balance information</p>
                                        <% } %>
                                      </div>
                                      
                                </div>
                            </div>
                            

                        </div>
                        <div class="form-group" id="payButtonGroup">
                            <button class="btn btn-primary" id="pay-button" disabled>Pay Now</button>
                          </div>
                        <div class="form-group" id="placeOrderGroup" style="display: none;">
                            <button type="button" class="btn btn-primary" id="placeOrderBtn">Place Order</button>
                          </div>
                    </form>

                    <form action="/add-address" method="post" id="addressForm" style="display: none;">
                        <div class="form-group mb-3">
                            <label class="text-black" for="name">Name </label>
                            <input type="text" name="name" class="form-control" id="name">
                        </div>
                        <div class="form-group mb-3">
                            <label class="text-black" for="mobile">Phone Number</label>
                            <input type="text" name="mobile" class="form-control" id="mobile">
                        </div>
                        <div class="form-group mb-3">
                            <label class="text-black" for="street">Flat, House no., Building, Company, Apartment</label>
                            <input type="text" name="street" class="form-control" id="street">
                        </div>
                        <div class="form-group mb-3">
                            <label class="text-black" for="area">Area, Street, Sector, Village</label>
                            <input type="text" name="area" class="form-control" id="area">
                        </div>
                        <div class="form-group mb-3">
                            <label class="text-black" for="landmark">Landmark</label>
                            <input type="text" name="landmark" class="form-control" id="landmark">
                        </div>
                        <div class="form-group mb-3">
                            <label class="text-black" for="pincode">Pincode</label>
                            <input type="text" name="pincode" class="form-control" id="pincode">
                        </div>
                        <div class="form-group mb-3">
                            <label class="text-black" for="addressType">Address Type</label>
                            <select name="addressType" class="form-control" id="addressType">
                                <option value="home">Home - 9:00 AM to 5:00 PM Delivery</option>
                                <option value="work">Work - 9:00 AM to 9:00 PM Delivery</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                        <br>
                        <br>
                    </form>
                </div>
            </div>

            <div class="col-md-6">
                <div class="row mb-5">
                    <div class="col-md-12">
                        
                        <h2 class="h3 mb-3 text-black">Order Summary</h2>
                        <div class="p-3 p-lg-5 border bg-white">
                            <table class="table site-block-order-table mb-5">
                                <thead>
                                    <th>Product</th>
                                    <th>Qty</th>
                                    <th>Total</th>
                                </thead>
                                <tbody>
                                    <% if (cart && cart.products && cart.products.length > 0) { %>
                                        <% cart.products.forEach(productItem => { %>
                                            <tr>
                                                <td><%= productItem.product.title %></td>

                                                <td> <strong class="mx-2">x</strong> <%= productItem.quantity %></td>
                                                <td><%= productItem.price %> <strong class="mx-2">x</strong> <%= productItem.quantity %> = <%= productItem.price * productItem.quantity %></td>
                                                

                                            </tr>
                                            
                                        <% }); %>
                                    <% } else { %>
                                    
                                        <tr>
                                            <td colspan="5">colum
                                                <h4>Your Fushion Furni Cart is empty. <a href="/shop">Continue Shopping</a></h4>
                                            </td>
                                        </tr>
                                    <% } %>
                                    <tr>
                                        <td>Discount</td>
                                    
                                        <% if (cart.totalAfterDiscount) { %>
                                            <td><strong class="mx-2">x</strong> 1</td>
                                            <td><%= cart.totalAfterDiscount %></td>
                                        <% } else { %>
                                            <td>No Discount Coupon Applied</td>
                                        <% } %>
                                    
                                        <td><strong class="mx-2"></td>
                                    </tr>
                                    <tr>
                                        <td class="text-black font-weight-bold"><strong>Order Total</strong></td>
                                        <td class="text-black font-weight-bold"><strong>₹<%=cart.cartTotal%></strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            <input type="hidden" id="amount" placeholder="Amount" name="orderTotal" value="<%=cart.cartTotal%>">
                            <input type="hidden" id="productName" placeholder="Product Name" name="nameUser" value="<%=user.name%>">
                            <input type="hidden" id="email" placeholder="Email" name="iemail" value="<%=user.email%>" >
                            <input type="hidden" id="mobile" placeholder="Email" name="mobile" value="<%=user.email%>" >
                            <input type="hidden" id="title" placeholder="title" name="title" value="<%= cart.products[0].title %>">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
 
 $(document).ready(function () {
        // Handling the "Online Payment" radio button
        $('#codRadio2').change(function () {
            if ($(this).is(':checked') && $(this).val() === 'OnlinePayment') {
                $('#payButtonGroup').show(); // Show the "Pay Now" button group
                $('#placeOrderGroup').hide(); // Hide the "Place Order" button group
            } else {
                $('#payButtonGroup').hide(); // Hide the "Pay Now" button group
            }
        });
        if (!$('#codRadio2').is(':checked') || $('#codRadio2:checked').val() !== 'OnlinePayment') {
            $('#payButtonGroup').hide();
        }

        // Handling the "Cash On Delivery" radio button
        $('#codRadio1').change(function () {
            if ($(this).is(':checked') && $(this).val() === 'COD') {
                $('#placeOrderGroup').show(); // Show the "Place Order" button group
                $('#payButtonGroup').hide(); // Hide the "Pay Now" button group
            } else {
                $('#placeOrderGroup').hide();
            }
        });

      
        if ($('input[name="paymentMethod"]:checked').val() !== 'COD') {
            $('#placeOrderGroup').hide();
        }

        $('#placeOrderBtn').click(function () {
            
        });
        $('#pay-button').click(function (e) {
    e.preventDefault();
    if (!$('input[name="addressSelection"]').is(':checked')) {
        showSweetMessage();
    } else {
        // Your existing logic here
    }

        });
        function showSweetMessage() {
            Swal.fire("Oops!", "Please select an address.", "warning");

        }
        
    });



$(document).ready(function() {
    $('input[name="paymentMethod"]').change(function() {
      if ($(this).is(':checked') && $(this).val() === 'COD') {
        $('#placeOrderGroup').show(); // Show the "Place Order" button
      } else {
        $('#placeOrderGroup').hide(); // Hide the "Place Order" button
      }
    });

    // Optional: If you want to hide the button on page load
    if ($('input[name="paymentMethod"]:checked').val() !== 'COD') {
      $('#placeOrderGroup').hide();
    }

    $('#placeOrderBtn').click(function() {
      // Add your logic for placing the order
      // ...
    });
  });
  $(document).ready(function () {
    $('#codRadio3').change(function () {
        if ($(this).is(':checked')) {
            $('#placeOrderGroup').show(); // Show the "Place Order" button
        } else {
            $('#placeOrderGroup').hide(); // Hide the "Place Order" button
        }
    });
});


    $(document).ready(function () {
        $("#codRadio2").change(function () {
                // Enable or disable the "Pay Now" button based on the radio button's checked status
                $("#pay-button").prop("disabled", !$(this).prop("checked"));
            })
        $("#addAddressCheckbox").change(function () {
            if (this.checked) {
                $("#addressForm").show();
            } else {
                $("#addressForm").hide();
            }
        });
       $('#codRadio2').change(function () {
                if ($(this).is(':checked')) {
                    $("#pay-button").prop("disabled", false);
                } else {
                    $("#pay-button").prop("disabled", true);
                }
            });
            

        $('#pay-button').click(function(e){
        e.preventDefault();

        // Collect values from input fields
        var productName = $('#productName').val();
        var amount = $('#amount').val();
        var email = $('#email').val();
        var mobile = $('#mobile').val();
        var product = $('#title').val();
        const selectedAddressId = $("input[name='addressSelection']:checked").val();

if (selectedAddressId) {
    $.ajax({
        url: "/create-online-payment",
        type: "POST",
        data: {
            productName: productName,
            amount: amount,
            email: email,
            product: product,
            addressId: selectedAddressId
        },
        success: function (res) {
            if (res.success) {
                var options = {
                    "key": res.key_id,
                    "amount": res.amount,
                    "currency": "INR",
                    "name": res.product,
                    "description": res.description,
                    "image": "https://dummyimage.com/600x400/000/fff",
                    "order_id": res.order_id,
                    "handler": function (response) {
                        // After successful payment, call the server to verify the payment
                        $.ajax({
                            url: "/create-order",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify({ payment_id: response.razorpay_payment_id,addressId:selectedAddressId }),
                            success: function (verificationResponse) {
                                if (verificationResponse.success) {
                                    window.location.href = "/thankyou";
                                } else {
                                    Swal.fire("Oops!", "Payment verification failed", "error");
                                }
                            },
                            error: function () {
                                Swal.fire("Oops!", "Error verifying payment", "error");
                            }
                        });
                    },
                    "prefill": {
                        "contact": res.contact,
                        "name": res.name,
                        "email": res.email
                    },
                    "notes": {
                        "description": res.description
                    },
                    "theme": {
                        "color": "#2300a3"
                    }
                };
                var razorpayObject = new Razorpay(options);
                razorpayObject.on('payment.failed', function (response) {
                    Swal.fire("Oops!", "Sorry, the payment failed. Please try again", "error");
                });
                razorpayObject.open();
            } else {
                alert(res.msg);
            }
        },
        error: function () {
            Swal.fire("Oops!", "Error creating online payment", "error");
        }
    });
} else {
    Swal.fire("Ooho!", "Please Select Address", "error");
}



    });

        $("#placeOrderBtn").click(function () {
    const selectedAddressId = $("input[name='addressSelection']:checked").val();
    const selectedPaymentMethod = $("input[name='paymentMethod']:checked").val();

    if (selectedAddressId && selectedPaymentMethod) {
        // You can now use Axios to send these values to a specified route
        axios.post('/create-order', {
            addressId: selectedAddressId,
            paymentMethod: selectedPaymentMethod
        })
        .then(function (response) {
            console.log('Order placed successfully:', response.data);
            // Redirect to the "/thankyou" route
            window.location.href = '/thankyou';
        })
        .catch(function (error) {
            window.location.href = '/view-cart';
            
        });
    } else {
        Swal.fire("Oops!", "Please select an address to continue", "error");
    }
}); 


    });
</script>


<%- include('../layout/footer.ejs') %>