<%- include('../layout/header.ejs') %>

<!-- Start Hero Section -->
<div class="hero">
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-lg-5">
        <div class="intro-excerpt">
          <h1>Shop</h1>
        </div>
      </div>
        <form action="">
      <div class="row">

          <div class="col-md-3">
            <div class="form-group mt-3">
              <label for="category-dropdown" style="color: aliceblue">Category:</label>
              <select class="form-select" id="category-dropdown" name="Category">
                <option value="all" <% if (categoryFilter === 'all') { %>selected<% } %>>All Categories</option>
                <% if (cat.length > 0) {
                  for (let i = 0; i < cat.length; i++) { %>
                    <option value="<%= cat[i].title %>" <% if (categoryFilter === cat[i].title) { %>selected<% } %>><%= cat[i].title %></option>
                  <% }
                } else { %>
                  <option disabled selected value="">No categories found</option>
                <% } %>
              </select>
          </div>
          
          </div>
          <div class="col-md-3">
              <div class="form-group mt-3">
                  <label for="price-range-min" style="color: aliceblue">Min Price:</label>
                  <input type="number" class="form-control" id="price-range-min" name="MinPrice" placeholder="Min Price" value="<%= minPriceFilter %>">
              </div>
          </div>
          <div class="col-md-3">
              <div class="form-group mt-3">
                  <label for="price-range-max" style="color: aliceblue">Max Price:</label>
                  <input type="number" class="form-control" id="price-range-max" name="MaxPrice" placeholder="Max Price" value="<%= maxPriceFilter %>">
              </div>
          </div>
          <div class="col-md-3">
            <div class="form-group mt-3">
              <label for="sort-dropdown" style="color: aliceblue">Sort:</label>
              <select class="form-control" id="sort-dropdown" name="Sort">
                <option value="default" <% if (sortOrder === 'default') { %>selected<% } %>>Default</option>
                <option value="priceHigh" <% if (sortOrder === 'priceHigh') { %>selected<% } %>>Price High to Low</option>
                <option value="priceLow" <% if (sortOrder === 'priceLow') { %>selected<% } %>>Price Low to High</option>
              </select>
            </div>
          </div>
          <div class="col-md-12 mt-3">
              <div class="input-group">
                      <div class="input-group">
                        <input
                        id="search-input"
                        type="search"
                        class="form-control"
                        placeholder="Search Your Products"
                        name="Search"
                        value="<%= search %>"
                      />
                    </div>
                    <div class="input-group-append">
                      <button
                        id="search-button"
                        type="submit"
                        class="btn btn-primary"
                        value="Search"
                      >
                      <div class="row">
                        <br>
                        <!-- Search Button -->
                        <div class="col-md-6">
                          <button type="submit" class="btn btn-primary" value="Search">
                            <i class="fa fa-search" style="color: #ffffff; font-size: 16px; margin-right: 5px;"></i>
                            Search
                          </button>
                        </div>
                      
                        <!-- Reset Filters Button -->
                        <div class="col-md-6">
                          <div class="col-md-12 mt-3">
                            <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                              Reset 
                            </button>
                          </div>
                        </div>
                      </div>
                      </div>
                  </form>
              </div>
          </div>
      </div>
      </div>

      <div class="col-lg-7"></div>
    </div>
  </div>
</div>
<!-- End Hero Section -->

<div class="untree_co-section product-section before-footer-section">
  <div class="container">
    <div class="row">
      <% if(getallProduct.length > 0) { for(let i = 0; i < getallProduct.length;
      i++) { %>

      <div class="col-12 col-md-4 col-lg-3 mb-5">
        <a class="product-item" href="/product/<%= getallProduct[i]._id %>">
          <img
            src="/productImage/<%= getallProduct[i].images[1] %>"
            class="img-fluid product-thumbnail"
          />
          <h3 class="product-title"><%= getallProduct[i].title %></h3>
          <strong class="product-price">â‚¹<%= getallProduct[i].price %></strong>

          <span class="icon-cross">
            <img src="/images/cross.svg" class="img-fluid" />
          </span>
        </a>
      </div>

      <% } } else { %>
      <td colspan="5">Products Not Found</td>
      <% } %>
    </div>
  </div>
</div>

<div class="container text-center mt-4">
  <nav aria-label="...">
    <ul class="pagination justify-content-center">
      <% if (currentPage > 1) { %>
      <li class="page-item">
        <a
          class="page-link"
          href="?page=<%= currentPage - 1 %>&Search=<%= search %>&Sort=<%= sortOrder %>"
          tabindex="-1"
          >Previous</a
        >
      </li>
      <% } else { %>
      <li class="page-item disabled">
        <span class="page-link" tabindex="-1">Previous</span>
      </li>
      <% } %> <% for (let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= (i === currentPage) ? 'active' : '' %>">
        <a
          class="page-link"
          href="?page=<%= i %>&Search=<%= search %>&Sort=<%= sortOrder %>"
          ><%= i %></a
        >
      </li>
      <% } %> <% if (currentPage < totalPages) { %>
      <li class="page-item">
        <a
          class="page-link"
          href="?page=<%= currentPage + 1 %>&Search=<%= search %>&Sort=<%= sortOrder %>"
          >Next</a
        >
      </li>
      <% } else { %>
      <li class="page-item disabled">
        <span class="page-link">Next</span>
      </li>
      <% } %>
    </ul>
  </nav>
</div>

<%- include('../layout/footer.ejs') %>
startDatePicker
endDatePicker
searchButton
<script>
  document.getElementById("search-button").addEventListener("click", () => {
    const searchInput = document.getElementById("search-input").value;
    const categoryFilter = document.getElementById("category-dropdown").value;
    const minPriceFilter = document.getElementById("price-range-min").value;
    const maxPriceFilter = document.getElementById("price-range-max").value;

    filterProducts(searchInput, categoryFilter, minPriceFilter, maxPriceFilter);
  });

  async function filterProducts(searchInput, categoryFilter, minPriceFilter, maxPriceFilter) {
    try {
      // Construct the URL with the filters
      let apiUrl = `/shop-filter?search=${searchInput}`;

      if (categoryFilter !== "all") {
        apiUrl += `&category=${categoryFilter}`;
      }

      if (minPriceFilter) {
        apiUrl += `&minPrice=${minPriceFilter}`;
      }

      if (maxPriceFilter) {
        apiUrl += `&maxPrice=${maxPriceFilter}`;
      }

      const response = await fetch(apiUrl);

      if (!response.ok) {
        throw new Error(`Error: ${response.status} - ${response.statusText}`);
      }

      const contentType = response.headers.get("content-type");
      if (contentType && contentType.includes("application/json")) {
        const data = await response.json();
        console.log(data);
        // Process the JSON data and update the UI as needed
      } else {
        console.error("Error: Unexpected response format");
        // Display an error message in the UI when the response is not in JSON format
      }
    } catch (error) {
      console.error("Error filtering products:", error);
      // Display an error message in the UI
    }
  }
</script>
