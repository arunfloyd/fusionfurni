<%- include('header.ejs') %>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<!-- Include the datepicker library -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datepicker@1.8.0/dist/datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/datepicker@1.8.0/dist/datepicker.min.js"></script>

<body>
<a href="/admin/dash">    <button type="button" class="btn btn-primary" >
      GO BACK 
    </button></a>
  <div class="screen-overlay"></div>
  
 
    <section class="content-main">
      <div class="content-header">
        <div>
          <h2 class="content-title card-title">Sales Report</h2>
          <p>Here you can see the sales report of your business</p>
        </div>
      
      </div>

      <div class="card mb-4">
        <div class="card-body">
          
       
        

          <article class="itemlist">
            <div class="row align-items-center">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="startDate" class="form-label">Start Date:</label>
                  <input type="date" id="startDate" class="form-control" autocomplete="off">
                </div>
                <div class="col-md-6">
                  <label for="endDate" class="form-label">End Date:</label>
                  <input type="date" id="endDate" class="form-control" autocomplete="off">
                </div>
              </div>
              <button onclick="filterOrders()">Filter Orders</button>

              
                <div class="card-body">
                    <div class="table-responsive">
                      <div class="table-responsive">
                        <table class="table align-middle table-nowrap mb-0">
                            <thead class="table-light">
                              <tr>
                                <th scope="col" class="text-center">
                                  <div class="form-check align-middle">
                                    <label class="form-check-label" for="transactionCheck01"></label>
                                  </div>
                                </th>
                                <th class="align-middle" scope="col">Order ID</th>
                                <th class="align-middle" scope="col">User Name</th>
                                <th class="align-middle" scope="col">Product Name</th>
                                <th class="align-middle" scope="col">Total</th>
                                <th class="align-middle" scope="col">Payment Status</th>
                                <th class="align-middle" scope="col">Payment Method</th>
                                <th class="align-middle" scope="col">Ordered Date & Time</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% userorders.reverse().forEach(order => { %>
                                <% order.products.forEach((productItem, index, array) => { %>
                                  <tr>
                                    <td class="text-center"></td>
                                    <td>
                                      <p class="fw-bold"><%= order.orderId %></p>
                                    </td>
                                    <td>
                                      <% order.populatedOrderBy.forEach(user => { %>
                                        <%= user.name %>
                                      <% }); %>
                                    </td>
                                    <td>
                                      <% order.populatedProducts.forEach(product => { %>
                                        <%= product.title %>
                                      <% }); %>
                                    </td>
                                    <td><%= order.paymentIntent.amount %></td>
                                    <td><%= order.paymentIntent.status %></td>
                                    <td><%= order.paymentIntent.method %></td>
                                    <td>
                                      <% if (index === array.length - 1) { %>
                                        <strong>
                                          <p>
                                            <%= new Date(order.createdAt).toLocaleString("en-US", {
                                              year: 'numeric',
                                              month: '2-digit',
                                              day: '2-digit',
                                              hour: '2-digit',
                                              minute: '2-digit',
                                              second: '2-digit'
                                            }) %>
                                          </p>
                                        </strong>
                                      <% } %>
                                    </td>
                                  </tr>
                                <% }); %>
                              <% }); %>
                            </tbody>
                          </table>
                          <h4 class="fw-bold">Total Amount: <%= grandTotal.length > 0 ? grandTotal[0].totalAmount : 0 %></h4>


                          
                    </div>
                    </div>
            </div>
          </article>
         
          
        </div>
      </div>
     
      <div class="container text-center mt-4">
        <button type="button" class="btn btn-primary" onclick="printScreen()">
          Print Report
        </button>
      </div>
    </section>

    <!-- content-main end// -->
    <%- include('footer.ejs') %>
  </main>
  <!-- Include Axios library -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
</body>

  
  function printScreen() {
    window.print();
  }
</script>

<script>
  async function filterOrders() {
    // Retrieve values from date inputs
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    console.log(startDate,endDate)

    try {
      console.log("Request URL:", `/sales-report?startDate=${startDate}&endDate=${endDate}`);
const response = await axios.get(`/sales-report?startDate=${startDate}&endDate=${endDate}`);
            console.log("Filtered Orders:", response.data);
            window.location.reload();
    } catch (error) {
      console.error('Error fetching filtered orders:', error);
    console.error('Response:', error.response); // Log the response details
    console.error('Request Config:', error.config);    }
  }
</script>
<script>
    const someJSONdata = []
    
  
  
    function printWithHeader() {
      printJS({
        printable: someJSONdata,
        type: 'json',
        properties: ['name', 'email', 'phone'],
        header: '<h3 class="custom-h3">My custom header</h3>',
        style: '.custom-h3 { color: red; }'
      });
    }
  </script>
