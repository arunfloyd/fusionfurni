
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>My Dashboard</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta property="og:title" content="" />
        <meta property="og:type" content="" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="" />
        
        <link rel="shortcut icon" type="image/x-icon" href="/images/theme/favicon.svg" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"  />
       
        <link href="/stylesheets/main.css" rel="stylesheet" type="text/css" />
      <!-- Template CSS -->
      
  
      <link
        rel="stylesheet"
        type="text/css"
        href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
      <script
        defer
        src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"
        integrity="sha384-rOA1PnstxnOBLzCLMcre8ybwbTmemjzdNlILg8O7z1lUkLXozs4DHonlDtnE7fpc"
        crossorigin="anonymous"
      ></script>
      <!-- DataTables CSS CDN -->
      <link
        rel="stylesheet"
        type="text/css"
        href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"
      />
    
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" integrity="sha512-hvNR0F/e2J7zPPfLC9auFe3/SE0yG4aJCOd/qxew74NN7eyiSKjr7xJJMu1Jy2wf7FXITpWS1E/RY8yzuXN7VA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
      <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.45.1/apexcharts.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"></script>
    </head>
    <body>
    <div class="screen-overlay"></div>
    <%- include('navbar-aside.ejs') %>
    <main class="main-wrap">
    
   <section class="content-main" id="addProductsPage">
  
    <div class="row">
        <!-- ... your existing form content ... -->
          <div class="col-9">
                    <div class="content-header">
                        <h2 class="content-title">Add New Product</h2>
                       
                    </div>
                </div>
                <div class="col-lg-6 pb-5">
                    <div class="card mb-4">
                        <div class="card-body">
                      <form  id="productForm" enctype="multipart/form-data" >
                        <div class="mb-4">
                            <label for="product_title" class="form-label">Product title</label>
                            <input type="text" placeholder="Type here" name="title" class="form-control" id="product_title" />
                            <span id="nameError" class="text-danger"></span>
                        </div>
                   
                           
                        </div>
                         <div class="card mb-4">
                            <div class="card-body">
                                <div>
                                    <label class="form-label">Description</label>
                                    <textarea placeholder="Type here" name="description" id="product_description" class="form-control" rows="4"></textarea>
                                    <span id="descriptionError" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div>
                                    <label class="form-label">Product Details</label>
                                    <textarea placeholder="Type here" name="productDetails" id="product_details" class="form-control" rows="4"></textarea>
                                    <span id="productDetailsError" class="text-danger"></span>
                                </div>
                            </div>
                        
                            <div class="card-body">
                                <div>
                                    <label class="form-label">Specification</label>
                                    <textarea placeholder="Type here" name="specification" id="specification" class="form-control" rows="4"></textarea>
                                    <span id="specificationError" class="text-danger"></span>
                                </div>
                            </div>
                        
                            <div class="card-body">
                                <div>
                                    <label class="form-label">Warranty</label>
                                    <textarea placeholder="Type here" name="warranty" id="warranty" class="form-control" rows="4"></textarea>
                                    <span id="warrantyError" class="text-danger"></span>
                                </div>
                            </div>
                        
                    </div>
                    </div>
                     <div class="card mb-4">
                            <div class="card-body">
                                <div>
                                    <!-- HERE IT WAS productImages  -->
                                    <label class="form-label">Choose upto 5 pictures</label>
                                    <input class="form-control" id="image-input" type="file" accept="image/*" multiple name="images"  required />
                                     <span id="imageError" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    <!-- card end// -->
           <div class="col-lg-12 cropped-image">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Preview cropped images</h4>
                    </div>
                    <div>
                        <!-- dynamic rendering by script -->
                        <div id="cropped-images" class="row"></div>
                       </div>
                    
                    

                    <div class="card-body col-lg-6">
                        <button type="button" id="submitFormButton" onclick="submitFormButton(event)" class="btn btn-md rounded font-sm hover-up" disabled> Save Product</button>

                        <!-- <button type="button" id="submitFormButton" onclick="validateForm(event)" class="btn btn-md rounded font-sm hover-up" disabled> Save Product</button> -->

                    </div>
                </div>
            </div>
        

        </div>
        


                <div class="col-lg-3">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="mb-4">
                                <label class="form-label">Price</label>
                                <input type="text" placeholder="Type here" name="price" id="price" class="form-control" />
                                <span id="priceError" class="text-danger"></span>
                            </div>
                             <div class="mb-4">
                                <label class="form-label">Stock Qty</label>
                                <input type="text" placeholder="Type here" name="quantity" id="quantity" class="form-control" />
                                <span id="quantityError" class="text-danger"></span>
                            </div>
                          
                            <hr />

                            <div class="row gx-2">
                                <div class="col-sm-6 mb-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" name="category" required>
                                        <% if(category.length > 0) { 
                                            for(let i = 0; i < category.length; i++) { %>
                                                <option><%= category[i].title %></option>
                                        <% } 
                                        } else { %>
                                            <option disabled selected value="">No categories found</option>
                                        <% } %>
                                    </select>
                                </div>
                            </div>
                            
</div>
</div>
</div>



                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Edit images</h4>
                    </div>
                    <div>
                        <!-- dynamic rendering by script -->
                     <div id="image-preview" class="row"></div>
                    </div>

                

                
                   </div>
                    <div class="card-body col-lg-6">
                        
                        <button type="button" id="crop-button" class="btn btn-md rounded font-sm hover-up" disabled> Crop Images</button>
                    </div>
          
        

    
              
</form>

          <% if (message) { %>
         <div class="error-message text-center text-danger">
        <%= message %>
        </div>
        <% } %>


</section>
</main>
</body>
<script src="/javascripts/vendors/jquery-3.6.0.min.js"></script>
<script src="/javascripts/vendors/bootstrap.bundle.min.js"></script>
<script src="/javascripts/vendors/select2.min.js"></script>
<script src="/javascripts/vendors/perfect-scrollbar.js"></script>
<script src="/javascripts/vendors/jquery.fullscreen.min.js"></script>
<script src="/javascripts/vendors/chart.js"></script>
<script src="/javascripts/custom-chart.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js" integrity="sha512-9KkIqdfN7ipEW6B6k+Aq20PV31bjODg4AA52W+tYtAE0jE0kMx49bjJ3FgvS56wzmyfMUHbQ4Km2b7l9+Y/+Eg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    let addProducts = document.getElementById('addProductsPage')

    console.log('hello')
    console.log(addProducts)

    if (addProducts) {
        let inputImage = document.getElementById("image-input");
        let previewImageContainer = document.getElementById("image-preview");
        let cropButton = document.getElementById("crop-button");
        let croppers = [];
        let croppedDataArray = [];
        let croppedImagesContainer = document.getElementById("cropped-images");
        let submitForm = document.getElementById("submitForm");

        //product details

        let productName = document.getElementById("product_title");
        let productDesc = document.getElementById("product_description");
        let productPrice = document.getElementById("price");
        let productQty = document.getElementById("quantity");
        let productCategory = document.getElementById('category')
        let productDetails = document.getElementById('productDetails')
        let specification = document.getElementById('specification')
        let warranty = document.getElementById('warranty')


        croppedImagesContainer.innerHTML = ''

        inputImage.addEventListener("change", (event) => {
            console.log('File input changed');
            const files = event.target.files;
            console.log('Number of selected files:', files.length);
            console.log('Selected files:', files);

            if (files.length > 5 || files.length < 5) {
                inputImage.value = '';
                Swal.fire({
                    icon: 'warning',
                    title: 'Oops...',
                    text: 'You can only select up to 5 images!',

                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });

            }

            if (files.length > 0) {

                // Clear the existing preview images
                previewImageContainer.innerHTML = "";
                croppers.length = 0;

                for (let file of files) {
                    let reader = new FileReader();

                    reader.onload = (readEvent) => {
                        let image = new Image();
                        image.src = readEvent.target.result;

                        let preview = document.createElement("div");
                        preview.classList.add("view-image", "col-lg-6");
                        preview.appendChild(image);

                        previewImageContainer.appendChild(preview);

                        cropButton.disabled = false;

                        let cropper = new Cropper(image, {
                            viewMode: 1,
                        });

                        croppers.push(cropper);
                    };

                    reader.readAsDataURL(file);
                }
            }
        });
        cropButton.addEventListener("click", async () => {
            croppedImagesContainer.innerHTML = ''
            submitFormButton.disabled = false;
            croppedDataArray = [];
            for (let cropper of croppers) {
                let croppedCanvas = cropper.getCroppedCanvas();

                let blobPromise = new Promise((resolve) => {
                    croppedCanvas.toBlob((blob) => {
                        resolve(blob);
                    });
                });
                let blob = await blobPromise;

                croppedDataArray.push(blob);
                displayCroppedImage(croppedImagesContainer, blob);
            }
            console.log(croppedDataArray);

            inputImage.value = "";
        });

        function displayCroppedImage(targetDiv, blob) {
            console.log("display crop image");
            let img = document.createElement("img");
            img.src = URL.createObjectURL(blob);

            let previewCroppedImage = document.createElement("div");
            previewCroppedImage.classList.add("col-lg-6");
            previewCroppedImage.appendChild(img);

            targetDiv.appendChild(previewCroppedImage);
        }



        submitFormButton.addEventListener("click", async (event) => {
            console.log('button clicked')
            event.preventDefault();


            let productName = document.getElementById('product_title').value;
            let productDescription = document.getElementById('product_description').value.trim();
            let price = document.getElementById('price').value;
            let quantity = document.getElementById('quantity').value;
            let imageInput = document.getElementById('image-input');
            let productDet = document.getElementById('productDetails').value
            let spec = document.getElementById('specification').value
            let war = document.getElementById('warranty').value

            // Create FormData
            let form = document.getElementById("productForm");
            let formData = new FormData(form);



            // Append images with different field names
            for (let i = 0; i < croppedDataArray.length; i++) {
                formData.append("image", croppedDataArray[i], `croppedImage_${i}.png`);
            }

            console.log(formData);

            // Check if the response is a redirect
            $.ajax({
                url: '/admin/product/add',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data.success === true) {
                        // Manually redirect to the specified location
                        window.location.href = '/admin/product/list';
                    } else {
                        // Handle other response scenarios if needed
                        console.error('Server response indicates failure:', data);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Handle network errors or other exceptions
                    console.error('AJAX error:', textStatus, errorThrown);
                }
            });
        });

        productPrice.addEventListener('input', () => {
            console.log('enter num')
            let value = productPrice.value;
            value = value.replace(/^0+/, '');

            if (value.includes("-")) {
                value = value.replace('-', '');
            }
            productPrice.value = value;

        })

        productQty.addEventListener('input', () => {
            console.log('enter num')
            let value = productQty.value;
            value = value.replace(/^0+/, '');

            if (value.includes("-")) {
                value = value.replace('-', ''); 3
            }
            productQty.value = value;

        })

       

    } else {
        console.log("Not in add products")
    }
    $('#submitFormButton').click(function (event){
    event.preventDefault();

    var fileInput = $('#image-input')[0];

    if (fileInput.files.length > 0) {
        for (var i = 0; i < fileInput.files.length; i++) {
            var file = fileInput.files[i];
            if (!file.type.startsWith('image/')) {
                alert('Invalid file type. Please select only image files.');
                return;
            }
        }
        // If all files are valid, you can submit the form
        document.getElementById('productForm').submit();

    }
    // $('#product_title').on('input', function() {
    //     validateField('product_title', 'nameError', /^[a-zA-Z][a-zA-Z\s]{8,68}[a-zA-Z]$/);
    // });
    $('#product_title').on('input', function() {
    validateField('product_title', 'nameError', /^[a-zA-Z][a-zA-Z\s]{8,68}[a-zA-Z]$/);
});
    function validateField(fieldName, errorId, regex) {
        var fieldValue = $('#' + fieldName).val();
        var errorSpan = $('#' + errorId);
        if (fieldValue.startsWith(' ')) {
                errorSpan.text('Title should not start with a space.');
                return;
            }
        if (!regex.test(fieldValue)) {
            errorSpan.text('Title must be between 10 and 70 characters and should not start.');
        } else {
            errorSpan.text('');
        }
    }
    $('#product_description').on('input', function() {
            validateDescription('product_description', 'descriptionError');
        });
        $('#product_details').on('input', function() {
            validateDescription('product_details', 'productDetailsError');
        });

        $('#specification').on('input', function() {
            validateDescription('specification', 'specificationError');
        });

        $('#warranty').on('input', function() {
            validateDescription('warranty', 'warrantyError');
        });
        function validateDescription(fieldName, errorId) {
    var fieldValue = $('#' + fieldName).val();
    var errorSpan = $('#' + errorId);

    // Check for starting space
    if (fieldValue.startsWith(' ')) {
        errorSpan.text(fieldName + ' should not start with a space.');
        return;
    }

    // Check for more than 50 words
    var wordCount = fieldValue.trim().split(/\s+/).filter(function (word) {
        return word.length > 0; // Filter out empty strings (e.g., due to multiple spaces)
    }).length;

    if (wordCount >= 5) {
        errorSpan.text('');
    } else {
        errorSpan.text(fieldName + ' should have more than 5 words.');
    }
}

});
 
});


</script>
                    
    

            </body>
            </html>
          