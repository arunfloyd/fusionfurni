<%- include('header.ejs') %>

<link rel="stylesheet" type="text/css" href="https://printjs-4de6.kxcdn.com/print.min.css">
<link rel="stylesheet" type="text/css" href="print.css">
<script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
<script src="print.js"></script>
<body>
  <div class="screen-overlay"></div>
  <%- include('navbar-aside.ejs') %>
  <main class="main-wrap">
    <section class="content-main">
      <div class="content-header">
        <div>
          <h2 class="content-title card-title">Sales Report</h2>
          <p>Here you can see the sales report of your business</p>
        </div>
      
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <article class="itemlist">
            <div class="row align-items-center">
                <div class="card-body">
                    <div class="table-responsive">
                      <div class="table-responsive">
                        <table class="table align-middle table-nowrap mb-0">
                            <thead class="table-light">
                              <tr>
                                <th scope="col" class="text-center">
                                  <div class="form-check align-middle">
                                    <label class="form-check-label" for="transactionCheck01"></label>
                                  </div>
                                </th>
                                <th class="align-middle" scope="col">Order ID</th>
                                <th class="align-middle" scope="col">User Name</th>
                                <th class="align-middle" scope="col">Product Name</th>
                                <th class="align-middle" scope="col">Total</th>
                                <th class="align-middle" scope="col">Payment Status</th>
                                <th class="align-middle" scope="col">Payment Method</th>
                                <th class="align-middle" scope="col">Ordered Date & Time</th>
                              </tr>
                            </thead>
                            <tbody id="reportBody">
                              <% userorders.reverse().forEach(order => { %>
                                <% order.products.forEach((productItem, index, array) => { %>
                                  <tr>
                                    <td class="text-center"></td>
                                    <td>
                                      <p class="fw-bold"><%= order.orderId %></p>
                                    </td>
                                    <td>
                                      <% order.populatedOrderBy.forEach(user => { %>
                                        <%= user.name %>
                                      <% }); %>
                                    </td>
                                    <td>
                                      <% order.populatedProducts.forEach(product => { %>
                                        <%= product.title %>
                                      <% }); %>
                                    </td>
                                    <td><%= order.paymentIntent.amount %></td>
                                    <td><%= order.paymentIntent.status %></td>
                                    <td><%= order.paymentIntent.method %></td>
                                    <td>
                                      <% if (index === array.length - 1) { %>
                                        <strong>
                                          <p>
                                            <%= new Date(order.createdAt).toLocaleString("en-US", {
                                              year: 'numeric',
                                              month: '2-digit',
                                              day: '2-digit',
                                              hour: '2-digit',
                                              minute: '2-digit',
                                              second: '2-digit'
                                            }) %>
                                          </p>
                                        </strong>
                                      <% } %>
                                    </td>
                                  </tr>
                                <% }); %>
                              <% }); %>
                            </tbody>
                          </table>
                          
                    </div>
                    </div>
            </div>
          </article>
          <span id="userorders" style="display: none"
          ><%=userorders%></span
        >
          
        </div>
      </div>
      <div class="container text-center mt-4">
        <button type="button" onclick="printWithHeader()">
            Print header raw HTML
          </button>
      </div>
    </section>

    <%- include('footer.ejs') %>
  </main>
</body>

<!-- Make sure to include Axios library -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>



<script>
  const reportBody = document.getElementById('reportBody');
  const someJSONdata = [];

  // Assuming salesReport is defined and contains the necessary data
  salesReport.forEach(order => {
    order.products.forEach(productItem => {
      const jsonDataEntry = {
        name: order.populatedOrderBy[0]?.name,
        email: order.user_id.email,
        phone: order.user_id.mobileNumber,
        address: order.delivery_address,
        orderID: order.orderId,
        date: new Date(order.createdAt).toLocaleString("en-US", {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        }),
        paymentMethod: order.paymentIntent.method,
        grandTotal: order.paymentIntent.amount
      };

      someJSONdata.push(jsonDataEntry);
    });
  });

  const tableHeader = `<tr>
    <th>Email</th>
    <th>Mobile</th>
    <th>Address</th>
    <th>Order ID</th>
    <th>Date</th>
    <th>Payment Method</th>
    <th>Grand Total</th>
  </tr>`;

  // Set the innerHTML of reportBody with the generated HTML
  reportBody.innerHTML = tableHeader + someJSONdata.map(element =>
    `<tr>
      <td>${element.email}</td>
      <td>${element.phone}</td>
      <td>${element.address}</td>
      <td>${element.orderID}</td>
      <td>${element.date}</td>
      <td>${element.paymentMethod}</td>
      <td>${element.grandTotal}</td>
    </tr>`
  ).join('');

  function printWithHeader() {
    printJS({
      printable: someJSONdata,
      type: 'json',
      properties: ['name', 'email', 'phone'],
      header: '<h3 class="custom-h3">My custom header</h3>',
      style: '.custom-h3 { color: red; }'
    });
  }
</script>




